# audio related functions

# sometimes i record audio from my amp
# and it needs noise reduction ... 
# this assumes that the first half second 
# is ambient noise!
deampify () {
	AUDIO_FILE="$1"

	if [[ -z "$AUDIO_FILE" ]]; then
		echo "Usage: deampify foo.[wav|flac] -d"
		echo ""
		echo "passing the -d option will delete"
		echo "the original audio file and replace"
		echo "it with the newly created one"
		echo ""
		return 0
	fi

	check_dependencies sox

	if [[ "$AUDIO_FILE" =~ ".flac" ]]; then
		FLAC_AUDIO_FILE="$AUDIO_FILE"
		WAV_AUDIO_FILE="${AUDIO_FILE/flac/wav}"

		echo "Converting $AUDIO_FILE to $WAV_AUDIO_FILE"
		if [[ -f "$WAV_AUDIO_FILE" ]]; then
			echo "Oops!  $WAV_AUDIO_FILE already exists!  exiting"
			return 1
		fi
		check_dependencies flac
		flac -d $AUDIO_FILE
		AUDIO_FILE="$WAV_AUDIO_FILE"
		if [[ ! -f "$AUDIO_FILE" ]]; then
			echo "File not found: $AUDIO_FILE ... flac conversion failed?"
			return 1
		fi
	fi

	NOW="$(date '+%m%d%Y_%H%M%S')"
	NOISE_PROFILE_DIR="/tmp/deampify"
	mkdir -p $NOISE_PROFILE_DIR
	NOISE_PROFILE_FILE="$NOISE_PROFILE_DIR/$NOW"
	NEW_AUDIO_FILE="${AUDIO_FILE/wav/deampified.wav}"

	echo "Creating noise profile using first .5 second of audio ..."
	sox $AUDIO_FILE -t nul /dev/null trim 0 0.5 noiseprof $NOISE_PROFILE_FILE

	echo "Creating new .wav file"
	sox $AUDIO_FILE $NEW_AUDIO_FILE noisered $NOISE_PROFILE_FILE 0.3

	DELETE_ORIGINAL="$2"
	if [[ -n "$DELETE_ORIGINAL" ]]; then
		echo "Deleting original file: $AUDIO_FILE"
		rm $AUDIO_FILE

		echo "Renaming $NEW_AUDIO_FILE to $AUDIO_FILE"
		mv $NEW_AUDIO_FILE $AUDIO_FILE

		if [[ -n "$FLAC_AUDIO_FILE" ]]; then
			echo "Deleting original flac: $FLAC_AUDIO_FILE"
			rm $FLAC_AUDIO_FILE
		fi
	fi
}

# vim:set ft=sh:
